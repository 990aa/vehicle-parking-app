{% extends "main.html" %}

{% block content %}
<!-- user navigation bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 sticky-top" >
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#" style="font-size: 1.6rem;">Vehicle Parking App</a>
    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
      <li class="nav-item">
        <a class="nav-link{% if request.path == url_for('user.user_dashboard') %} active{% endif %}" href="{{ url_for('user.user_dashboard') }}">Dashboard</a>
      </li>
      <li class="nav-item">
        <a class="nav-link{% if request.path == url_for('user.user_booking') %} active{% endif %}" href="{{ url_for('user.user_booking') }}">Book Spot</a>
      </li>
      <li class="nav-item">
        <a class="nav-link{% if request.path == url_for('user.user_history') %} active{% endif %}" href="{{ url_for('user.user_history') }}">History</a>
      </li>
    </ul>
    <a href="{{ url_for('authorisation.logout') }}" class="btn btn-outline-light">Logout</a>
  </div>
</nav>
<div class="page active" id="userBooking">
    <!-- booking page, checked for missing lots, compared with admin lots for consistency -->
    <h2 class="mb-4">Book a Parking Spot</h2>

    <div class="row" id="availableLots">
        <form id="filterForm" class="row mb-4" method="get" action="{{ url_for('user.user_booking') }}">
            <div class="col-md-3 mb-2 mb-md-0">
                {# Set min and default value to today #}
                <input type="date" name="date" class="form-control" style="max-width: 300px;"
                    value="{{ selected_date|default(today) }}"
                    min="{{ today }}">
            </div>
            <div class="col-md-4 mb-2 mb-md-0">
                <input type="text" class="form-control" name="q" placeholder="Search by lot name, address, pin code..." value="{{ lot_search_query|default('') }}">
            </div>
            <div class="col-md-3 mb-2 mb-md-0">
                <select class="form-select" name="field" style="max-width: 150px;">
                    <option value="all" {% if lot_search_field == 'all' %}selected{% endif %}>All Fields</option>
                    <option value="name" {% if lot_search_field == 'name' %}selected{% endif %}>Lot Name</option>
                    <option value="address" {% if lot_search_field == 'address' %}selected{% endif %}>Address</option>
                    <option value="pin_code" {% if lot_search_field == 'pin_code' %}selected{% endif %}>Pin Code</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn--primary w-90">Search/Check Availability</button>
            </div>
        </form>
        {% if lots %}
            {% for lot in lots %}
            <div class="col-md-6 col-lg-4 mb-4">
                <!-- parking-lot-card, disables if no spots, checked backend for available_spots_count -->
                <div class="parking-lot-card {% if lot.avl_spots == 0 %}disabled{% endif %}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0">{{ lot.prime_location_name }}</h5>
                        <!-- price, forced 2 decimals, had rounding issues before -->
                        <span class="price-display">â‚¹{{ "%.2f"|format(lot.price_per_hr) }}/hr</span>
                    </div>
                    <p class="text-muted mb-2">{{ lot.address }}</p>
                    <p class="text-muted mb-2">Pin Code: {{ lot.pin_code }}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <!-- spot-status, toggles class based on available_spots_count, checked in browser -->
                        <span class="spot-status {{ 'available' if lot.avl_spots > 0 else 'occupied' }}">
                            <i class="fas fa-circle me-1"></i>
                            {{ lot.avl_spots }} / {{ lot.max_spots }} Available
                        </span>
                        {% if lot.avl_spots > 0 %}
                            <!-- booking form, POST to book_spot_action, checked endpoint in routes -->
                            <form method="POST" action="{{ url_for('user.book_spot', lot_id=lot.id) }}">
                                <div class="mb-2">
                                    <label for="vehicle_number_{{ lot.id }}" class="form-label mb-1">Vehicle Number</label>
                                    <input type="text" name="vehicle_number" id="vehicle_number_{{ lot.id }}" class="form-control form-control-sm" placeholder="Enter vehicle number" required maxlength="20">
                                </div>
                                <!-- Date is selected globally, not per lot -->
                                <input type="hidden" name="date" value="{{ selected_date|default(today) }}">
                                <button type="submit" class="btn btn--sm btn--primary confirm-delete" data-confirm-message="Confirm booking for {{lot.prime_location_name}}?">
                                    <i class="fas fa-plus me-1"></i>Book
                                </button>
                            </form>
                        {% else %}
                            <!-- no spots, disables card, checked that button is hidden -->
                            <span class="text-muted">No spots available</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="col-12">
            <!-- empty state, checked icon renders, used same style as admin lots -->
            <div class="empty-state">
                <i class="fas fa-warehouse"></i>
                <p>No parking lots available at the moment.</p>
            </div>
        </div>
        {% endif %}
    </div>

    {# Removed bookingInfo div as booking confirmation is now a direct action #}
</div>
{% endblock %}